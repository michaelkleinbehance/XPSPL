#!/usr/bin/php
<?php
/**
 * Directly run files in a prggmr daemon.
 */
$usage = "usage: prggmrd [options] FILE

Current options:
  -v    Displays current prggmr version.
  -s    Sync all timer clocks with the daemons clock on startup.
  -t    Length of time to run in milliseconds.
  -d    Run debug mode.
  -h    Shows this help message.
";

if (count($argv) == 1) {
    exit($usage);
}

$sync = false;
$ttr = null;
// last param is file
$runfile = $argv[$argc - 1];
$options = getopt('qwert:yuiopasdfghjklzxcvbnm');

// parse args and check for options
foreach ($options as $_i => $_arg) {
    switch ($_i) {
        case 's':
            $sync = true;
            break;
        case 't':
            if (false === $_arg || !is_int($_arg + 0)) {
                exit("invalid option 't'\n".$usage);
            }
            $ttr = $_arg + 0;
            break;
        case 'd':
            define('PRGGMR_DEBUG', true);
            break;
        case 'h':
            exit($usage);
            break;
        case 'v':
            $showversion = true;
            break;
        default:
            exit(sprintf(
                "Unknown option %s",
                $_arg
            ));
            break;
    }
}

if (false === $runfile) {
    exit($usage);
}

// load prggmr
if (!class_exists('Prggmr')) {
    // attempt to include prggmr lib on include path
    require 'prggmr/lib/prggmr.php';
}

if (isset($showversion)) exit('prggmr version '.PRGGMR_VERSION." by Nickolas Whiting
");

if (!file_exists($runfile)) {
    die("Unknown file : $runfile\n");
} else {
    require $runfile;
}

// start the daemon child!!
prggmrd($sync, $ttr);