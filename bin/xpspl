#!/usr/bin/env php
<?php
/**
 * Directly runs files in the XPSPL event loop
 */
$usage = 
"usage: XPSPL [-c|--config=<file>] [-d] [-h|--help] [-p|--passthru] [--test]
              [--test-cover] [-t|--time=<time>] [-v|--version]
              <file>
Options:
  -c/--config   Load the giving file for configuration
  -d            Debug Mode
  -h/--help     Show this help message.
  -p/--passthru Ignore any subsequent arguments and pass to <file>.
  --test        Run the XPSPL unit tests.
  --test-cover  Run unit tests and generate code coverage.
  -t/--time     Run for the given amount of milliseconds.
  -v/--version  Displays current XPSPL version.
";

$sync = false;
$ttr = null;
$runfile = false;
$it = true;
array_shift($argv);
if (count($argv) === 0) {
    goto start;
}
// last param is file
$runfile = $argv[count($argv) - 1];
// if - is first char ignore file
if (strpos($runfile, '-') === 0) {
    $runfile = false;
}

if ($runfile != false) {
    $it = false;
}

$options = getopt(
    'qwert:yuiopasdfghjklzxc:vbnm',
    [
        'help', 'config:', 'version', 'time:', 'test', 'test-cover'
    ]
);
$tmp = $argv;
$unittesting = false;
$coverage = false;
// parse args and check for options
foreach ($options as $_i => $_arg) {
    // Hack
    $break = false;
    switch ($_i) {
        case 'p':
        case 'passthru':
            $break = true;
            break;
        case 't':
        case 'time':
            if (false === $_arg || !is_int($_arg + 0)) {
                exit("invalid option 't'\n".$usage);
            }
            $ttr = $_arg + 0;
            break;
        case 'h':
        case 'help':
            exit($usage);
            break;
        case 'v':
        case 'version':
            $showversion = true;
            break;
        case 'c':
        case 'config':
            include($_arg);
            break;
        case 'd':
            define('XPSPL_DEBUG', true);
            break;
        case 'test':
        case 'test-cover':
            $unittest = true;
            if (!defined('XPSPL_DEBUG')) {
                define('XPSPL_DEBUG', false);
            }
            if ($_i === 'test-cover') {
                define('GENERATE_CODE_COVERAGE', true);
            }
            $it = false;
            break;
        default:
            exit(sprintf(
                "Unknown option '%s'\n%s",
                $_i,
                $usage
            ));
            break;
    }
    if ($break) break;
}

start:

// load XPSPL
if (!class_exists('XPSPL')) {
    require_once dirname(realpath(__FILE__)).'/../src/XPSPL.php';
}

if (isset($showversion)) {
    echo 'XPSPL Version '.XPSPL_VERSION.PHP_EOL;
    echo XPSPL_MASTERMIND.PHP_EOL;
    exit(0);
}

if (isset($unittest)) {
    import('unittest');
    require XPSPL_PATH.'/tests/run.php';
}

if (false !== $runfile) {
    if (!file_exists($runfile)) {
        die("Could not open $runfile\n");
    } else {
        require_once $runfile;
    }
}

// start the loop!!
wait_loop($ttr);
